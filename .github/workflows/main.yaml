name: Aquapump CI/CD

on:
  push:
    branches:
      - main
      - release/**
  pull_request:
    branches:
      - main
  workflow_dispatch: {}

env:
  AWS_REGION: eu-central-1
  BACKEND_REPOSITORY: aquapump/backend
  FRONTEND_REPOSITORY: aquapump/frontend
  IMAGE_TAG: ${{ github.sha }}

permissions:
  contents: read
  id-token: write

jobs:
  frontend_quality:
    name: Frontend lint & build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"
          cache-dependency-path: package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Lint
        run: npm run lint

      - name: Build
        run: npm run build

  backend_quality:
    name: Backend dependency & syntax check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"
          cache-dependency-path: backend/requirements.txt

      - name: Install dependencies
        run: pip install -r backend/requirements.txt

      - name: Compile sources
        run: python -m compileall backend/app

  build_and_push:
    name: Build & push container images
    runs-on: ubuntu-latest
    needs:
      - frontend_quality
      - backend_quality
    strategy:
      fail-fast: false
      matrix:
        include:
          - service: backend
            dockerfile: backend/Dockerfile
            repository: ${{ env.BACKEND_REPOSITORY }}
          - service: frontend
            dockerfile: frontend/Dockerfile
            repository: ${{ env.FRONTEND_REPOSITORY }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_GITHUB_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Set registry environment
        run: echo "REGISTRY=${{ steps.login-ecr.outputs.registry }}" >> $GITHUB_ENV

      - name: Set image tags
        run: |
          REPOSITORY="${{ matrix.repository }}"
          if [[ "${GITHUB_REF}" == "refs/heads/main" ]]; then
            echo "IMAGE_TAGS=${REGISTRY}/${REPOSITORY}:${IMAGE_TAG},${REGISTRY}/${REPOSITORY}:latest" >> $GITHUB_ENV
          else
            echo "IMAGE_TAGS=${REGISTRY}/${REPOSITORY}:${IMAGE_TAG}" >> $GITHUB_ENV
          fi
        shell: bash

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push ${{ matrix.service }} image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ${{ matrix.dockerfile }}
          push: true
          tags: ${{ env.IMAGE_TAGS }}
          cache-from: type=gha,scope=${{ matrix.service }}
          cache-to: type=gha,scope=${{ matrix.service }},mode=max

  deploy:
    name: Update Helm & sync Argo CD
    runs-on: ubuntu-latest
    needs: build_and_push
    if: github.ref == 'refs/heads/main'
    permissions:
      contents: write
      id-token: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_GITHUB_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Update Helm image tags
        uses: mikefarah/yq@v4
        with:
          cmd: |
            yq -i '.backend.image.tag = strenv(IMAGE_TAG)' deploy/helm/aquapump/values.yaml
            yq -i '.frontend.image.tag = strenv(IMAGE_TAG)' deploy/helm/aquapump/values.yaml
        env:
          IMAGE_TAG: ${{ env.IMAGE_TAG }}

      - name: Commit Helm manifest updates
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore(ci): update container tags to ${{ env.IMAGE_TAG }}"
          commit_user_name: aquapump-ci
          commit_user_email: ci@aquapump.dev
          file_pattern: deploy/helm/aquapump/values.yaml

      - name: Trigger Argo CD sync
        uses: clowdhaus/argo-cd-action@v3.1.0
        with:
          address: ${{ secrets.ARGOCD_SERVER }}
          auth-token: ${{ secrets.ARGOCD_AUTH_TOKEN }}
          action: sync
          appName: aquapump

      - name: Verify Argo CD application health
        shell: bash
        run: |
          echo "Waiting for Argo CD application to be Healthy and Synced..."
          SERVER_RAW="${{ secrets.ARGOCD_SERVER }}"
          SERVER_SANITIZED="${SERVER_RAW#*://}"
          SERVER_SANITIZED="${SERVER_SANITIZED%%/}"
          printf '::add-mask::%s\n' "$SERVER_SANITIZED"
          ARGOCD_ARGS=("--server" "$SERVER_SANITIZED" "--auth-token" "${{ secrets.ARGOCD_AUTH_TOKEN }}" "--insecure")
          if [[ "$SERVER_RAW" == http://* || "$SERVER_RAW" == https://* ]]; then
            ARGOCD_ARGS+=("--grpc-web")
          fi
          for i in {1..20}; do
            STATUS=$(argocd app get aquapump "${ARGOCD_ARGS[@]}" -o json | jq -r '.status.health.status')
            SYNC=$(argocd app get aquapump "${ARGOCD_ARGS[@]}" -o json | jq -r '.status.sync.status')
            echo "Attempt $i: Sync=$SYNC | Health=$STATUS"
            if [[ "$STATUS" == "Healthy" && "$SYNC" == "Synced" ]]; then
              exit 0
            fi
            sleep 15
          done
          echo "Application failed to become Healthy in time."
          exit 1

      - name: Roll back Argo CD application
        if: failure()
        shell: bash
        run: |
          echo "Rolling back Argo CD application..."
          SERVER_RAW="${{ secrets.ARGOCD_SERVER }}"
          SERVER_SANITIZED="${SERVER_RAW#*://}"
          SERVER_SANITIZED="${SERVER_SANITIZED%%/}"
          printf '::add-mask::%s\n' "$SERVER_SANITIZED"
          ARGOCD_ARGS=("--server" "$SERVER_SANITIZED" "--auth-token" "${{ secrets.ARGOCD_AUTH_TOKEN }}" "--insecure")
          if [[ "$SERVER_RAW" == http://* || "$SERVER_RAW" == https://* ]]; then
            ARGOCD_ARGS+=("--grpc-web")
          fi
          argocd app rollback aquapump "${ARGOCD_ARGS[@]}"
