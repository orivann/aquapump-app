name: Build and Deploy to Amazon ECR

on:
  push:
    branches:
      - main
      - release/**
  workflow_dispatch: {}

env:
  AWS_REGION: eu-north-1
  ECR_REPOSITORY_BACKEND: aquapump/backend
  ECR_REPOSITORY_FRONTEND: aquapump/frontend
  IMAGE_TAG: ${{ github.sha }}

jobs:
  build-and-push:
    name: Build Docker images
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_GITHUB_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build backend image
        run: |
          docker build -f backend/Dockerfile -t ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY_BACKEND }}:${{ env.IMAGE_TAG }} .

      - name: Build frontend image
        run: |
          docker build -f frontend/Dockerfile -t ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY_FRONTEND }}:${{ env.IMAGE_TAG }} .

      - name: Push images
        run: |
          docker push ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY_BACKEND }}:${{ env.IMAGE_TAG }}
          docker push ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY_FRONTEND }}:${{ env.IMAGE_TAG }}

      - name: Update latest tags
        if: github.ref == 'refs/heads/main'
        run: |
          docker tag ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY_BACKEND }}:${{ env.IMAGE_TAG }} ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY_BACKEND }}:latest
          docker tag ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY_FRONTEND }}:${{ env.IMAGE_TAG }} ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY_FRONTEND }}:latest
          docker push ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY_BACKEND }}:latest
          docker push ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY_FRONTEND }}:latest

  deploy:
    name: Trigger ArgoCD Sync
    needs: build-and-push
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_GITHUB_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Patch image tags in Helm values
        uses: mikefarah/yq@v4
        with:
          cmd: |
            yq -i '.image.backend.tag = "${{ env.IMAGE_TAG }}"' deploy/helm/aquapump/values.yaml
            yq -i '.image.frontend.tag = "${{ env.IMAGE_TAG }}"' deploy/helm/aquapump/values.yaml


      - name: Commit and push changes
        uses: EndBug/add-and-commit@v9
        with:
          message: "chore(ci): update container tags to ${{ env.IMAGE_TAG }}"
          add: deploy/helm/aquapump/values.yaml

      - name: Notify Argo CD
        uses: clowdhaus/argo-cd-action@v3
        with:
          version: v2.10.4
          address: ${{ secrets.ARGOCD_SERVER }}
          auth-token: ${{ secrets.ARGOCD_AUTH_TOKEN }}
          command: app sync aquapump
