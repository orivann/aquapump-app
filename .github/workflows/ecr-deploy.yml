name: Build and Deploy to Amazon ECR via Argo CD

on:
  push:
    branches:
      - main
      - release/**
  workflow_dispatch: {}

env:
  AWS_REGION: eu-central-1
  ECR_REPOSITORY_BACKEND: aquapump/backend
  ECR_REPOSITORY_FRONTEND: aquapump/frontend
  IMAGE_TAG: ${{ github.sha }}

permissions:
  id-token: write
  contents: read

jobs:
  build-and-push:
    name: Build & Push Docker Images
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_GITHUB_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      
      - name: Build backend image
        run: |
          docker build -f backend/Dockerfile -t ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY_BACKEND }}:${{ env.IMAGE_TAG }} .

     
      - name: Build frontend image
        run: |
          docker build -f frontend/Dockerfile -t ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY_FRONTEND }}:${{ env.IMAGE_TAG }} .

      
      - name: Push images
        run: |
          docker push ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY_BACKEND }}:${{ env.IMAGE_TAG }}
          docker push ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY_FRONTEND }}:${{ env.IMAGE_TAG }}


      - name: Update latest tags
        if: github.ref == 'refs/heads/main'
        run: |
          docker tag ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY_BACKEND }}:${{ env.IMAGE_TAG }} ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY_BACKEND }}:latest
          docker tag ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY_FRONTEND }}:${{ env.IMAGE_TAG }} ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY_FRONTEND }}:latest
          docker push ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY_BACKEND }}:latest
          docker push ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY_FRONTEND }}:latest

  deploy:
    name: Update Helm + Sync Argo CD + Health Check
    needs: build-and-push
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    permissions:
      id-token: write
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_GITHUB_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Patch Helm image tags
        uses: mikefarah/yq@v4
        with:
          cmd: |
            yq -i '.image.backend.tag = strenv(IMAGE_TAG)' deploy/helm/aquapump/values.yaml
            yq -i '.image.frontend.tag = strenv(IMAGE_TAG)' deploy/helm/aquapump/values.yaml
        env:
          IMAGE_TAG: ${{ env.IMAGE_TAG }}

      - name: Commit and push Helm updates
        uses: EndBug/add-and-commit@v9
        with:
          message: "chore(ci): update container tags to ${{ env.IMAGE_TAG }}"
          add: deploy/helm/aquapump/values.yaml

      
      - name: Sync Argo CD
        uses: clowdhaus/argo-cd-action@v3.1.0
        with:
          address: ${{ secrets.ARGOCD_SERVER }}
          auth-token: ${{ secrets.ARGOCD_AUTH_TOKEN }}
          action: sync
          appName: aquapump

      - name: Check Argo CD app health
        id: health
        run: |
          echo "Waiting for ArgoCD application to be healthy..."
          for i in {1..20}; do
            STATUS=$(argocd app get aquapump --server ${{ secrets.ARGOCD_SERVER }} --auth-token ${{ secrets.ARGOCD_AUTH_TOKEN }} --insecure -o json | jq -r '.status.health.status')
            SYNC=$(argocd app get aquapump --server ${{ secrets.ARGOCD_SERVER }} --auth-token ${{ secrets.ARGOCD_AUTH_TOKEN }} --insecure -o json | jq -r '.status.sync.status')
            echo "Sync: $SYNC | Health: $STATUS"
            if [[ "$STATUS" == "Healthy" && "$SYNC" == "Synced" ]]; then
              echo "✅ ArgoCD app is Healthy and Synced"
              exit 0
            fi
            sleep 15
          done
          echo "❌ Application failed to reach Healthy state in time"
          exit 1
        shell: bash

      - name: Rollback ArgoCD app if unhealthy
        if: failure()
        run: |
          echo "Rolling back ArgoCD application..."
          argocd app rollback aquapump --server ${{ secrets.ARGOCD_SERVER }} --auth-token ${{ secrets.ARGOCD_AUTH_TOKEN }} --insecure
