# ==============================================================================
# üåä AQUAPUMP APP - CI/CD PIPELINE (FINAL)
# ------------------------------------------------------------------------------

name: Aquapump CI/CD

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

concurrency:
  group: aquapump-main
  cancel-in-progress: true

permissions:
  contents: write
  id-token: write

env:
  AWS_REGION: eu-central-1
  FRONTEND_REPOSITORY: aquapump/frontend
  BACKEND_REPOSITORY: aquapump/backend

jobs:
  prepare:
    name: üß© Prepare Metadata
    runs-on: ubuntu-latest      
    outputs:
      image-tag: ${{ steps.meta.outputs.image_tag }}
      push-images: ${{ steps.meta.outputs.push_images }}
    steps:
      - id: meta
        name: Derive image tag & push flag
        run: |
          BRANCH_NAME="${GITHUB_HEAD_REF:-${GITHUB_REF_NAME}}"
          SANITIZED_BRANCH=$(echo "$BRANCH_NAME" | tr '[:upper:]' '[:lower:]' | tr -c 'a-z0-9-.' '-')
          SHORT_SHA=${GITHUB_SHA::7}
          IMAGE_TAG="${SHORT_SHA}-${SANITIZED_BRANCH}"
          if [[ "${GITHUB_EVENT_NAME}" == "push" && "${GITHUB_REF}" == "refs/heads/main" ]]; then
            PUSH_IMAGES=true
          else
            PUSH_IMAGES=false
          fi
          {
            echo "image_tag=${IMAGE_TAG}"
            echo "push_images=${PUSH_IMAGES}"
          } >> "$GITHUB_OUTPUT"

  frontend-lint:
    name: üß† Frontend Checks
    runs-on: ubuntu-latest
    needs: prepare
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: npm
          cache-dependency-path: package-lock.json
      - run: npm ci
      - run: npm run lint
      - run: npx --yes prettier@3.4.2 --check .
      - run: npm run build

  backend-lint:
    name: üß† Backend Checks
    runs-on: ubuntu-latest
    needs: prepare
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: pip
          cache-dependency-path: backend/requirements.txt
      - run: |
          pip install \
            -r backend/requirements.txt \
            black==24.10.0 \
            bandit==1.7.10
      - run: black --check backend
      - run: bandit -q -r backend --severity-level high
      - run: python -m compileall backend/app

  security-scan:
    name: üîí Trivy Security Scan
    runs-on: ubuntu-latest
    needs: prepare
    steps:
      - uses: actions/checkout@v4
      - name: Run filesystem scan
        uses: aquasecurity/trivy-action@0.22.0
        with:
          scan-type: fs
          format: table
          exit-code: "1"
          ignore-unfixed: true
          vuln-type: "os,library"
          severity: "CRITICAL,HIGH"

  build:
    name: üê≥ Build & Push Images
    runs-on: ubuntu-latest
    needs: [prepare, frontend-lint, backend-lint, security-scan]
    strategy:
      fail-fast: false
      matrix:
        include:
          - service: backend
            dockerfile: backend/Dockerfile
            repository_env: BACKEND_REPOSITORY
          - service: frontend
            dockerfile: frontend/Dockerfile
            repository_env: FRONTEND_REPOSITORY
    env:
      IMAGE_TAG: ${{ needs.prepare.outputs.image-tag }}
      PUSH_IMAGES: ${{ needs.prepare.outputs.push-images }}
    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_GITHUB_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-session-name: github-actions-${{ github.run_id }}
          role-duration-seconds: 1800

      - uses: aws-actions/amazon-ecr-login@v2
        id: login-ecr

      - name: Set ECR registry
        run: echo "ECR_REGISTRY=${{ steps.login-ecr.outputs.registry }}" >> "$GITHUB_ENV"

      - id: tags
        run: |
          REPOSITORY="${{ env[matrix.repository_env] }}"
          BASE_TAG="${ECR_REGISTRY}/${REPOSITORY}:${IMAGE_TAG}"
          if [[ "${PUSH_IMAGES}" == "true" ]]; then
            LATEST_TAG="${ECR_REGISTRY}/${REPOSITORY}:latest"
            echo "IMAGE_TAGS=${BASE_TAG},${LATEST_TAG}" >> "$GITHUB_ENV"
          else
            echo "IMAGE_TAGS=${BASE_TAG}" >> "$GITHUB_ENV"
          fi

      - uses: docker/setup-buildx-action@v3

      - name: Build & push ${{ matrix.service }}
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ${{ matrix.dockerfile }}
          push: ${{ env.PUSH_IMAGES == 'true' }}
          tags: ${{ env.IMAGE_TAGS }}

  deploy:
    name: üöÄ Deploy via ArgoCD
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
    needs: [prepare, build]
    env:
      IMAGE_TAG: ${{ needs.prepare.outputs.image-tag }}
      AWS_REGION: eu-central-1
    permissions:
      contents: write
      id-token: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_GITHUB_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Update Helm image tags (All Environments)
        uses: mikefarah/yq@v4
        with:
          cmd: |
            for env in dev stage prod; do
              yq -i ".backend.image.tag = strenv(IMAGE_TAG)" deploy/helm/aquapump/environments/values-${env}.yaml
              yq -i ".frontend.image.tag = strenv(IMAGE_TAG)" deploy/helm/aquapump/environments/values-${env}.yaml
            done

      - name: Commit manifest updates
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore(ci): update image tags to ${{ env.IMAGE_TAG }} for all environments"
          commit_user_name: aquapump-ci
          commit_user_email: ci@aquapump.dev
          file_pattern: deploy/helm/aquapump/environments/values-*.yaml

      - name: Trigger ArgoCD sync for all environments
        uses: clowdhaus/argo-cd-action@v3.1.0
        with:
          address: ${{ secrets.ARGOCD_SERVER }}
          auth-token: ${{ secrets.ARGOCD_AUTH_TOKEN }}
          action: sync
          appName: |
            aquapump-dev
            aquapump-stage
            aquapump-prod

      - name: Verify ArgoCD health (prod)
        run: |
          echo "‚è≥ Waiting for aquapump-prod to be Healthy..."
          for i in {1..20}; do
            STATUS=$(argocd app get aquapump-prod --server ${{ secrets.ARGOCD_SERVER }} --auth-token ${{ secrets.ARGOCD_AUTH_TOKEN }} -o json | jq -r '.status.health.status')
            SYNC=$(argocd app get aquapump-prod --server ${{ secrets.ARGOCD_SERVER }} --auth-token ${{ secrets.ARGOCD_AUTH_TOKEN }} -o json | jq -r '.status.sync.status')
            echo "Attempt $i: Sync=$SYNC | Health=$STATUS"
            if [[ "$STATUS" == "Healthy" && "$SYNC" == "Synced" ]]; then
              echo "‚úÖ aquapump-prod is healthy!"
              break
            fi
            sleep 15
          done

      - name: Smoke test API
        run: |
          echo "Running smoke test..."
          curl -fsS https://api.aqua-pump.net/health || exit 1

      - name: Rollback on failure
        if: failure()
        run: |
          echo "‚ö†Ô∏è Rolling back ArgoCD application..."
          argocd app rollback aquapump-prod --server ${{ secrets.ARGOCD_SERVER }} --auth-token ${{ secrets.ARGOCD_AUTH_TOKEN }}
