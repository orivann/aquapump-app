---
# ==============================================================================
# Aquapump App CI/CD Workflow
# ----------------------------------------------------------------------------
# Orchestrates quality checks, container builds, security scanning, and deploy
# steps for the Aquapump application repository.
# Uses GitHub OIDC for AWS access and pushes images to ECR.
# ==============================================================================
name: Aquapump App CI/CD

"on":
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

permissions:
  contents: read
  id-token: write

env:
  AWS_REGION: eu-central-1
  FRONTEND_REPOSITORY: aquapump/frontend
  BACKEND_REPOSITORY: aquapump/backend

jobs:
  prepare:
    name: Prepare build metadata
    runs-on: ubuntu-latest
    outputs:
      image-tag: ${{ steps.meta.outputs.image_tag }}
      push-images: ${{ steps.meta.outputs.push_images }}
    steps:
      - id: meta
        name: Derive image tag and push flag
        shell: bash
        run: |
          BRANCH_NAME="${GITHUB_HEAD_REF:-${GITHUB_REF_NAME}}"
          SANITIZED_BRANCH=$(
            echo "$BRANCH_NAME" |
              tr '[:upper:]' '[:lower:]' |
              tr -c 'a-z0-9-.' '-'
          )
          SHORT_SHA=${GITHUB_SHA::7}
          IMAGE_TAG="${SHORT_SHA}-${SANITIZED_BRANCH}"
          if [[ "${GITHUB_EVENT_NAME}" == "push" ]] &&
             [[ "${GITHUB_REF}" == "refs/heads/main" ]]; then
            PUSH_IMAGES=true
          else
            PUSH_IMAGES=false
          fi
          {
            echo "image_tag=${IMAGE_TAG}"
            echo "push_images=${PUSH_IMAGES}"
          } >> "$GITHUB_OUTPUT"

  frontend_checks:
    name: Frontend lint, format & build
    runs-on: ubuntu-latest
    needs: prepare
    env:
      IMAGE_TAG: ${{ needs.prepare.outputs.image-tag }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: npm
          cache-dependency-path: package-lock.json

      - name: Install frontend dependencies
        run: npm ci

      - name: Run ESLint
        run: npm run lint

      - name: Check formatting with Prettier
        run: npx --yes prettier@3.4.2 --check .

      - name: Build frontend
        run: npm run build

  backend_checks:
    name: Backend style & compile checks
    runs-on: ubuntu-latest
    needs: prepare
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: pip
          cache-dependency-path: backend/requirements.txt

      - name: Install Python dependencies
        run: |
          pip install \
            -r backend/requirements.txt \
            black==24.10.0 \
            bandit==1.7.10

      - name: Check formatting with Black
        run: black --check backend

      - name: Run Bandit security scan
        run: bandit -q -r backend
        continue-on-error: false

      - name: Compile sources
        run: python -m compileall backend/app

  security_scan:
    name: Trivy security scan
    runs-on: ubuntu-latest
    needs: prepare
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run Trivy filesystem scan
        uses: aquasecurity/trivy-action@0.22.0
        with:
          scan-type: fs
          format: table
          exit-code: "1"
          ignore-unfixed: true
          vuln-type: "os,library"
          severity: "CRITICAL,HIGH"

  build_and_push:
    name: Build and publish container images
    runs-on: ubuntu-latest
    needs:
      - prepare
      - frontend_checks
      - backend_checks
      - security_scan
    strategy:
      fail-fast: false
      matrix:
        include:
          - service: backend
            dockerfile: backend/Dockerfile
            repository_env: BACKEND_REPOSITORY
          - service: frontend
            dockerfile: frontend/Dockerfile
            repository_env: FRONTEND_REPOSITORY
    env:
      IMAGE_TAG: ${{ needs.prepare.outputs.image-tag }}
      PUSH_IMAGES: ${{ needs.prepare.outputs.push-images }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_GITHUB_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Set registry value
        run: |
          REGISTRY="${{ steps.login-ecr.outputs.registry }}"
          echo "ECR_REGISTRY=${REGISTRY}" >> "$GITHUB_ENV"

      - name: Determine image tags
        id: tags
        shell: bash
        run: |
          REPOSITORY="${{ env[matrix.repository_env] }}"
          BASE_TAG="${ECR_REGISTRY}/${REPOSITORY}:${IMAGE_TAG}"
          if [[ "${PUSH_IMAGES}" == "true" ]]; then
            LATEST_TAG="${ECR_REGISTRY}/${REPOSITORY}:latest"
            echo "IMAGE_TAGS=${BASE_TAG},${LATEST_TAG}" >> "$GITHUB_ENV"
          else
            echo "IMAGE_TAGS=${BASE_TAG}" >> "$GITHUB_ENV"
          fi

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push ${{ matrix.service }} image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ${{ matrix.dockerfile }}
          push: ${{ env.PUSH_IMAGES == 'true' }}
          tags: ${{ env.IMAGE_TAGS }}
          cache-from: type=gha,scope=${{ matrix.service }}
          cache-to: type=gha,scope=${{ matrix.service }},mode=max

  deploy:
    name: Update manifests & trigger Argo CD
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
    needs:
      - prepare
      - build_and_push
    env:
      IMAGE_TAG: ${{ needs.prepare.outputs.image-tag }}
    permissions:
      contents: write
      id-token: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_GITHUB_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Update Helm image tags
        uses: mikefarah/yq@v4
        with:
          cmd: |
            VALUES_FILE="deploy/helm/aquapump/values.yaml"
            yq -i '.backend.image.tag = strenv(IMAGE_TAG)' "$VALUES_FILE"
            yq -i '.frontend.image.tag = strenv(IMAGE_TAG)' "$VALUES_FILE"

      - name: Commit manifest updates
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: >-
            chore(ci): update container tags to ${{ env.IMAGE_TAG }}
          commit_user_name: aquapump-ci
          commit_user_email: ci@aquapump.dev
          file_pattern: deploy/helm/aquapump/values.yaml

      - name: Trigger Argo CD sync
        uses: clowdhaus/argo-cd-action@v3.1.0
        with:
          address: ${{ secrets.ARGOCD_SERVER }}
          auth-token: ${{ secrets.ARGOCD_AUTH_TOKEN }}
          action: sync
          appName: aquapump-prod

      - name: Verify Argo CD application health
        shell: bash
        run: |
          echo "Waiting for Argo CD application to be Healthy and Synced..."
          SERVER_RAW="${{ secrets.ARGOCD_SERVER }}"
          SERVER_SANITIZED="${SERVER_RAW#*://}"
          SERVER_SANITIZED="${SERVER_SANITIZED%%/}"
          printf '::add-mask::%s\n' "$SERVER_SANITIZED"
          ARGOCD_ARGS=(
            "--server" "$SERVER_SANITIZED"
            "--auth-token" "${{ secrets.ARGOCD_AUTH_TOKEN }}"
            "--insecure"
          )
          if [[ "$SERVER_RAW" == http://* || "$SERVER_RAW" == https://* ]]; then
            ARGOCD_ARGS+=("--grpc-web")
          fi
          for i in {1..20}; do
            STATUS=$(
              argocd app get aquapump-prod "${ARGOCD_ARGS[@]}" -o json |
                jq -r '.status.health.status'
            )
            SYNC=$(
              argocd app get aquapump-prod "${ARGOCD_ARGS[@]}" -o json |
                jq -r '.status.sync.status'
            )
            echo "Attempt $i: Sync=$SYNC | Health=$STATUS"
            if [[ "$STATUS" == "Healthy" && "$SYNC" == "Synced" ]]; then
              exit 0
            fi
            sleep 15
          done
          echo "Application failed to become Healthy in time."
          exit 1

      - name: Roll back Argo CD application
        if: failure()
        shell: bash
        run: |
          echo "Rolling back Argo CD application..."
          SERVER_RAW="${{ secrets.ARGOCD_SERVER }}"
          SERVER_SANITIZED="${SERVER_RAW#*://}"
          SERVER_SANITIZED="${SERVER_SANITIZED%%/}"
          printf '::add-mask::%s\n' "$SERVER_SANITIZED"
          ARGOCD_ARGS=(
            "--server" "$SERVER_SANITIZED"
            "--auth-token" "${{ secrets.ARGOCD_AUTH_TOKEN }}"
            "--insecure"
          )
          if [[ "$SERVER_RAW" == http://* || "$SERVER_RAW" == https://* ]]; then
            ARGOCD_ARGS+=("--grpc-web")
          fi
          argocd app rollback aquapump-prod "${ARGOCD_ARGS[@]}"
